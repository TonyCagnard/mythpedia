{% extends "mythpedia/base.html" %}
{% load static %} {# Si vous utilisez des fichiers statiques locaux #}

{% block title_tag_content %}{{ character.name }} - {{ character.mythology.title }} - MythPedia{% endblock %}

{% block main_page_heading %}{{ character.name }}{% endblock %}

{% block content %}
    <div class="bg-white p-4 md:p-6 rounded-lg shadow-lg">
        <div class="mb-4 md:mb-6 pb-4 md:pb-6 border-b border-gray-200">
            {% if character.role %}
                <p class="text-lg md:text-xl text-blue-600 font-semibold -mt-1 md:-mt-2 mb-1 md:mb-2">{{ character.role }}</p>
            {% endif %}
            <p class="text-xs md:text-sm text-gray-500">
                Mythologie :
                {# CORRECTION ICI #}
                <a href="{% url 'mythpedia:mythology_detail' mythology_slug=character.mythology.slug %}" class="text-blue-500 hover:underline">
                    {{ character.mythology.title }}
                </a>
            </p>
        </div>

        {# SECTION POUR LES BOUTONS FAVORIS DE PERSONNAGE (CORRIGÉE) #}
        <div class="my-4 md:my-6 text-center sm:text-left">
            {% if user.is_authenticated %}
                {% if is_favorite_character %}
                    <form action="{% url 'mythpedia:remove_character_from_favorites' mythology_slug=character.mythology.slug character_slug=character.slug %}" method="post" style="display: inline-block;">
                        {% csrf_token %}
                        <button type="submit" class="px-3 py-1.5 md:px-5 md:py-2.5 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors text-xs md:text-sm font-medium shadow-md">
                            <i class="fas fa-user-minus mr-1 md:mr-2"></i> Retirer des Favoris
                        </button>
                    </form>
                {% else %}
                    <form action="{% url 'mythpedia:add_character_to_favorites' mythology_slug=character.mythology.slug character_slug=character.slug %}" method="post" style="display: inline-block;">
                        {% csrf_token %}
                        <button type="submit" class="px-3 py-1.5 md:px-5 md:py-2.5 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors text-xs md:text-sm font-medium shadow-md">
                            <i class="fas fa-user-plus mr-1 md:mr-2"></i> Ajouter aux Favoris
                        </button>
                    </form>
                {% endif %}
            {% else %}
                <p class="text-gray-600 text-sm md:text-base">
                    {# Assurez-vous que 'login' est le bon nom d'URL (il est souvent global) #}
                    <a href="{% url 'login' %}?next={{ request.path }}" class="text-blue-600 hover:underline font-medium">Connectez-vous</a> pour ajouter ce personnage à vos favoris.
                </p>
            {% endif %}
        </div>
        {# FIN SECTION FAVORIS #}

        {% if character.image_url %}
            <div class="mb-4 md:mb-6 float-right ml-4 md:ml-6 w-full sm:w-1/3 max-w-xs clear-none sm:clear-right">
                <img src="{{ character.image_url }}" alt="{{ character.name }}" class="rounded-lg shadow-md object-cover w-full">
            </div>
        {% endif %}
        
        <div class="prose max-w-none text-gray-700 leading-relaxed text-xs md:text-sm lg:text-base">
            {{ character.description|linebreaksbr }}
        </div>
        
        <div style="clear: both;"></div> {# Pour nettoyer le float de l'image #}

        {# Section pour les histoires où le personnage apparaît (CORRIGÉE) #}
        {% if character.featured_in_stories.all %} {# Utilise le related_name 'featured_in_stories' du modèle MythStory #}
            <h3 class="text-lg md:text-xl font-semibold text-blue-700 mt-6 md:mt-8 mb-2 md:mb-3 pt-4 md:pt-6 border-t border-gray-200">Apparaît dans :</h3>
            <ul class="list-disc list-inside text-gray-600 space-y-1 text-xs md:text-sm">
                {% for story in character.featured_in_stories.all %}
                    <li>
                        <a href="{% url 'mythpedia:mythstory_detail' mythology_slug=story.mythology.slug story_slug=story.slug %}" class="hover:underline">
                            {{ story.title }}
                        </a>
                    </li>
                {% endfor %}
            </ul>
        {% endif %}
    </div>

    {# Inclure la section des commentaires et notations #}
    {% include "mythpedia/_comments_section.html" %}

    {# Boutons de partage social #}
    {% include "mythpedia/_share_buttons.html" with share_title=character.name share_text="Découvrez "|add:character.name|add:", un personnage fascinant de la mythologie "|add:character.mythology.title|add:" sur MythPedia !" %}

    <div class="mt-6 md:mt-10 text-center">
        {# CORRECTION ICI #}
        <a href="{% url 'mythpedia:mythology_detail' mythology_slug=character.mythology.slug %}" class="text-blue-600 hover:underline font-medium text-sm md:text-base">
            ← Retour à la mythologie {{ character.mythology.title }}
        </a>
    </div>
{% endblock %}